# DIAMM

<div align="center">

**åˆ†å¸ƒå¼æ™ºèƒ½å¤šæ¨¡æ€ç®¡ç†ç³»ç»Ÿ**

ä¸€ä¸ªåŸºäº Kubernetes çš„å¤šæ¨¡æ€ AI æœåŠ¡ç¼–æ’ä¸ç®¡ç†å¹³å°

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

</div>

---

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#-é¡¹ç›®ç®€ä»‹)
- [æ ¸å¿ƒç‰¹æ€§](#-æ ¸å¿ƒç‰¹æ€§)
- [ç³»ç»Ÿæ¶æ„](#-ç³»ç»Ÿæ¶æ„)
- [å¿«é€Ÿå¼€å§‹](#-å¿«é€Ÿå¼€å§‹)
  - [ç¯å¢ƒè¦æ±‚](#ç¯å¢ƒè¦æ±‚)
  - [ä¾èµ–å®‰è£…](#ä¾èµ–å®‰è£…)
  - [æœåŠ¡å¯åŠ¨](#æœåŠ¡å¯åŠ¨)
- [ä½¿ç”¨æŒ‡å—](#-ä½¿ç”¨æŒ‡å—)
- [ç¤ºä¾‹å±•ç¤º](#-ç¤ºä¾‹å±•ç¤º)
- [é¡¹ç›®ç»“æ„](#-é¡¹ç›®ç»“æ„)
- [è®¸å¯è¯](#-è®¸å¯è¯)

---

## ğŸš€ é¡¹ç›®ç®€ä»‹

DIAMM (Distributed Intelligent Multimodal Management) æ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„å¤šæ¨¡æ€ AI æœåŠ¡ç®¡ç†å¹³å°ï¼Œæ”¯æŒæ–‡æœ¬ã€å›¾åƒã€è§†é¢‘ç­‰å¤šç§æ¨¡æ€çš„ AI æ¨¡å‹ç»Ÿä¸€è°ƒåº¦ä¸ç®¡ç†ã€‚ç³»ç»ŸåŸºäº Kubernetes æ„å»ºï¼Œæä¾›é«˜å¯ç”¨ã€å¯æ‰©å±•çš„åˆ†å¸ƒå¼æœåŠ¡æ¶æ„ã€‚

### ä¸»è¦åŠŸèƒ½

- ğŸ”„ **å¤šæ¨¡æ€ä»»åŠ¡è°ƒåº¦**ï¼šæ”¯æŒæ–‡æœ¬ç”Ÿæˆã€å›¾åƒç”Ÿæˆã€è§†é¢‘ç”Ÿæˆç­‰å¤šç§ä»»åŠ¡ç±»å‹
- âš¡ **é«˜æ€§èƒ½æ¨ç†**ï¼šåŸºäº vLLM å’Œä¼˜åŒ–çš„æ¨ç†å¼•æ“
- ğŸ“Š **èµ„æºç›‘æ§**ï¼šé›†æˆ Prometheusã€DCGMã€Jtop å’Œ Tegrastatsï¼Œå®æ—¶ç›‘æ§ GPU ä½¿ç”¨æƒ…å†µ
- ğŸ” **æ¨¡å‹ç®¡ç†**ï¼šæ”¯æŒæ¨¡å‹æƒé‡å®Œæ•´æ€§æ£€æŸ¥ã€åˆ†å¸ƒå¼éƒ¨ç½²
- ğŸŒ **Web ç•Œé¢**ï¼šæä¾›å‹å¥½çš„ Web UI è¿›è¡Œä»»åŠ¡æäº¤å’Œç»“æœæŸ¥çœ‹

---

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- âœ… åŸºäº Kubernetes çš„å®¹å™¨åŒ–éƒ¨ç½²
- âœ… æ”¯æŒå¤šç§å¤šæ¨¡æ€æ¨¡å‹ï¼ˆLLMã€å›¾åƒç”Ÿæˆã€è§†é¢‘ç”Ÿæˆï¼‰
- âœ… æ™ºèƒ½èµ„æºè°ƒåº¦ç®—æ³•ï¼ˆQMSDï¼‰
- âœ… å®æ—¶ä»»åŠ¡çŠ¶æ€ç›‘æ§ï¼ˆCelery + Flowerï¼‰
- âœ… å‘é‡æ•°æ®åº“æ”¯æŒï¼ˆPGVectorï¼‰
- âœ… åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰
- âœ… RESTful API æ¥å£
- âœ… å¹¶å‘æµ‹è¯•å·¥å…·

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web Frontend  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FastAPI       â”‚â”€â”€â”€â”€â–¶â”‚   Celery     â”‚
â”‚   Service       â”‚     â”‚   Workers    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Kubernetes Cluster               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  vLLM    â”‚  â”‚ Multimodalâ”‚         â”‚
â”‚  â”‚  Models  â”‚  â”‚  Models   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PostgreSQL    â”‚     â”‚    Redis     â”‚
â”‚   (PGVector)    â”‚     â”‚   (Cache)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Kubernetes é›†ç¾¤ï¼ˆæ¨è 1.24+ï¼‰
- Docker æˆ–å®¹å™¨è¿è¡Œæ—¶
- Python 3.12+
- è‡³å°‘ 1 ä¸ª GPU èŠ‚ç‚¹ï¼ˆç”¨äºæ¨¡å‹æ¨ç†ï¼‰
  - æ”¯æŒ x86 æ¶æ„ï¼ˆIntel/AMD CPU + NVIDIA GPUï¼‰
  - æ”¯æŒ ARM æ¶æ„ï¼ˆNVIDIA Jetson ç³»åˆ—è®¾å¤‡ï¼‰
- NFS æœåŠ¡å™¨ï¼ˆç”¨äºæ¨¡å‹æƒé‡å…±äº«ï¼‰

### ä¾èµ–å®‰è£…

#### 1. æ•°æ®åº“æœåŠ¡

æˆ‘ä»¬æ¨èä½¿ç”¨ Docker æˆ– Kubernetes éƒ¨ç½² PostgreSQL å’Œ Redisã€‚

##### PostgreSQL (PGVector)

**é•œåƒåœ°å€ï¼š**
```
docker.io/ankane/pgvector:v0.5.1
```

**æ¨èé…ç½®ï¼ˆConfigMapï¼‰ï¼š**
```yaml
work_mem = 64MB
shared_buffers = 6GB
maintenance_work_mem = 512MB
```

##### Redis

**é•œåƒåœ°å€ï¼š**
```
docker.io/library/redis:7.2-alpine
```

**æ¨èé…ç½®ï¼ˆredis.confï¼‰ï¼š**
```conf
maxmemory 10GB
bind 0.0.0.0
protected-mode no
requirepass "123456"
```

#### 2. å¤šæ¨¡æ€æ¨¡å‹é•œåƒ

ç³»ç»Ÿéœ€è¦åœ¨ Kubernetes å·¥ä½œèŠ‚ç‚¹ä¸Šé¢„ç½®ä»¥ä¸‹ Docker é•œåƒï¼š

| æ¨¡å‹ç±»å‹ | é•œåƒåœ°å€ | è¯´æ˜ |
|---------|---------|------|
| LLM æ¨ç† | `docker.io/library/lmdeploy-new:v0.6.4-cu11` | åŸºäº LMDeploy çš„ LLM æœåŠ¡ |
| Ollama | `docker.io/ollama/ollama:latest` | Ollama æ¨¡å‹æœåŠ¡ |
| è§†é¢‘ç”Ÿæˆ | `docker.io/library/cogvideox2b:0.1` | CogVideoX è§†é¢‘ç”Ÿæˆæ¨¡å‹ |
| å›¾åƒç”Ÿæˆ | `docker.io/aoirint/sd_webui:0.2` | Stable Diffusion WebUI |

> ğŸ’¡ **æç¤º**ï¼šåä¸¤ä¸ªé•œåƒçš„ Dockerfile ä½äº `Multimodal_files/` ç›®å½•ï¼Œåˆ†åˆ«åŸºäºå®˜æ–¹æ¨¡å‹å’Œ Xformer ä¼˜åŒ–ç‰ˆæœ¬æ„å»ºã€‚

#### 2.1. Jetson ç¯å¢ƒé…ç½®

> ğŸ¯ **ARM æ¶æ„æ”¯æŒ**ï¼šJetson è®¾å¤‡ä½¿ç”¨ ARM æ¶æ„ï¼Œé•œåƒä¸ x86 ç¯å¢ƒä¸åŒã€‚

å¯¹äº Jetson è®¾å¤‡ï¼ˆNVIDIA Jetson ç³»åˆ—ï¼‰ï¼Œæˆ‘ä»¬å·²åœ¨ `Jetson/` ç›®å½•ä¸­æä¾›äº†å¯¹åº”çš„ ARM æ¶æ„é•œåƒ Dockerfile ä»¥åŠç›¸å…³é…ç½®æ–‡ä»¶ï¼š

- **ARM æ¶æ„é•œåƒ Dockerfile**ï¼šé€‚ç”¨äº Jetson è®¾å¤‡çš„å®¹å™¨é•œåƒæ„å»ºæ–‡ä»¶
- **jtop ç­‰å­˜å‚¨èµ„æºæŸ¥è¯¢å·¥å…·**ï¼šç”¨äºç›‘æ§ Jetson è®¾å¤‡çš„å­˜å‚¨å’Œèµ„æºä½¿ç”¨æƒ…å†µ

**ä½¿ç”¨æ–¹æ³•ï¼š**
1. è¿›å…¥ `Jetson/` ç›®å½•æŸ¥çœ‹å¯¹åº”çš„ Dockerfile
2. ä½¿ç”¨ ARM æ¶æ„çš„ Dockerfile æ›¿æ¢ x86 ç‰ˆæœ¬çš„é•œåƒæ„å»ºæ–‡ä»¶
3. æ ¹æ® Jetson è®¾å¤‡çš„å…·ä½“å‹å·å’Œé…ç½®è¿›è¡Œç›¸åº”è°ƒæ•´

> âš ï¸ **æ³¨æ„**ï¼šJetson ç¯å¢ƒä¸‹çš„é•œåƒéœ€è¦é’ˆå¯¹ ARM æ¶æ„é‡æ–°ç¼–è¯‘ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨ x86 æ¶æ„çš„é•œåƒã€‚

#### 3. Prometheus ç›‘æ§

ç³»ç»Ÿé€šè¿‡ Prometheus æŸ¥è¯¢å®¹å™¨çŠ¶æ€ï¼Œéœ€è¦ DCGM æ’ä»¶è·å– GPU ä½¿ç”¨æƒ…å†µã€‚

**é…ç½®æ–‡ä»¶ä½ç½®ï¼š** `/prometheus/dcgm-exporter-servicemonitor.yaml`

å°†é…ç½®æ–‡ä»¶åŠ è½½åˆ° Kubernetes é›†ç¾¤ä¸­ï¼š
```bash
kubectl apply -f prometheus/dcgm-exporter-servicemonitor.yaml
```

#### 4. Python ç¯å¢ƒ

ä½¿ç”¨ Conda å®‰è£… Python ä¾èµ–ï¼š

```bash
conda env create -f environment.yml
conda activate diamm
```

---

### æœåŠ¡å¯åŠ¨

#### Master èŠ‚ç‚¹æœåŠ¡

åœ¨ Master èŠ‚ç‚¹ä¸Šå¯åŠ¨ä»¥ä¸‹æœåŠ¡è¿›ç¨‹ï¼š

##### 1. ä»»åŠ¡ç»“æœå±•ç¤ºæœåŠ¡
```bash
cd vLLM-k8s-operator/user_tasks
python show.py
```

##### 2. å‘é‡åµŒå…¥æœåŠ¡
```bash
cd vLLM-k8s-operator/models/embedding
python main.py
```

##### 3. FastAPI ä¸»æœåŠ¡
```bash
cd vLLM-k8s-operator
python -m program.fastapi_app
```

##### 4. QMSD è°ƒåº¦ç®—æ³•æœåŠ¡
```bash
cd vLLM-k8s-operator/deployment/deployment_design
python algorithm_proposed.py
```

##### 5. DIAMM å¤šæ¨¡æ€é¢„çƒ­æœåŠ¡
```bash
cd vLLM-k8s-operator/deployment/service_drop
python main.py
```

##### 6. æƒé‡å®Œæ•´æ€§æ£€æŸ¥æœåŠ¡
```bash
cd vLLM-k8s-operator/check_weight
python main.py
```

##### 7. Prometheus-DCGM æ£€æŸ¥æœåŠ¡
```bash
cd vLLM-k8s-operator/check_weight
python Prometheus_start.py
```

##### 8. Web å‰ç«¯æœåŠ¡
```bash
python web-end.py
```

#### NFS æœåŠ¡å™¨æœåŠ¡

åœ¨ NFS æœåŠ¡å™¨ä¸Šå¯åŠ¨ä»¥ä¸‹æœåŠ¡ï¼š

##### 1. æƒé‡åˆ†å‘æœåŠ¡
```bash
cd NFS_server/send_weight
python main_drop.py
```

##### 2. æ–‡ä»¶æœåŠ¡
```bash
cd NFS_server
python show.py
```

#### Celery ä»»åŠ¡é˜Ÿåˆ—

ä½¿ç”¨ Supervisor ç®¡ç† Celery æœåŠ¡ï¼š

**é…ç½®æ–‡ä»¶ä½ç½®ï¼š** `/etc/supervisor/conf.d/celery.conf`

```bash
# é‡æ–°åŠ è½½é…ç½®
sudo supervisorctl reread

# æ›´æ–°æœåŠ¡
sudo supervisorctl update

# é‡å¯æ‰€æœ‰æœåŠ¡
sudo supervisorctl restart all
```

> ğŸ“ **æ³¨æ„**ï¼šåç»­ç‰ˆæœ¬å°†æä¾›å®¹å™¨åŒ–éƒ¨ç½²æ–¹æ¡ˆå’Œè‡ªåŠ¨åŒ–å¯åŠ¨è„šæœ¬ã€‚

---

## ğŸ“– ä½¿ç”¨æŒ‡å—

å¯åŠ¨æ‰€æœ‰æœåŠ¡åï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä½¿ç”¨ DIAMM å¤šæ¨¡æ€æœåŠ¡ï¼š

### 1. å¹¶å‘æµ‹è¯•ç¨‹åº

ä½¿ç”¨å†…ç½®çš„å¹¶å‘æµ‹è¯•å·¥å…·è¿›è¡Œå‹åŠ›æµ‹è¯•å’Œæ€§èƒ½è¯„ä¼°ï¼š

```bash
cd test
python send_task.py
```

**åŠŸèƒ½ç‰¹æ€§ï¼š**
- âœ… å¯é…ç½®å¹¶å‘æ•°é‡
- âœ… æ”¯æŒå¤šç§ä»»åŠ¡ç±»å‹ï¼ˆæ–‡æœ¬ã€å›¾åƒã€è§†é¢‘ç­‰ï¼‰
- âœ… å¯è‡ªå®šä¹‰ä»»åŠ¡ç±»å‹æ¯”ä¾‹
- âœ… å®æ—¶ç»Ÿè®¡ä»»åŠ¡æ‰§è¡Œæƒ…å†µ

### 2. Web ç•Œé¢è®¿é—®

ç³»ç»Ÿæä¾›å‹å¥½çš„ Web ç•Œé¢è¿›è¡Œä»»åŠ¡æäº¤å’Œç»“æœæŸ¥çœ‹ï¼š

**è®¿é—®åœ°å€ï¼š** `http://localhost:8989`

**åŠŸèƒ½åŒ…æ‹¬ï¼š**
- ğŸ“ ä»»åŠ¡æäº¤
- ğŸ“Š ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢
- ğŸ–¼ï¸ ç»“æœé¢„è§ˆå’Œä¸‹è½½
- ğŸ“ˆ æ‰§è¡Œç»Ÿè®¡

> âš ï¸ **æ€§èƒ½æç¤º**ï¼šå¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼ˆä½é¢‘ä½¿ç”¨åœºæ™¯ï¼‰ï¼Œå»ºè®®è‡³å°‘ä¿ç•™ä¸€ä»½å¸¸ç”¨æ¨¡å‹çš„å‰¯æœ¬ï¼Œé¿å…é¢‘ç¹æ¸…ç†å¯¼è‡´çš„å†·å¯åŠ¨å»¶è¿Ÿã€‚

---

## ğŸ–¼ï¸ ç¤ºä¾‹å±•ç¤º

### Celery-Flower ä»»åŠ¡ç›‘æ§

å®æ—¶æŸ¥çœ‹ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€å’Œé˜Ÿåˆ—æƒ…å†µï¼š

![ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€æŸ¥è¯¢](./test/img/celery.jpeg)

### Web UI ç•Œé¢

é€šè¿‡ Web ç•Œé¢æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œç»“æœï¼š

![ä»»åŠ¡æ‰§è¡Œç»“æœ](./test/img/webui.jpg)

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
DIAMM/
â”œâ”€â”€ vLLM-k8s-operator/          # æ ¸å¿ƒæœåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ program/                # FastAPI ä¸»ç¨‹åº
â”‚   â”œâ”€â”€ deployment/             # éƒ¨ç½²ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ deployment_design/  # QMSD è°ƒåº¦ç®—æ³•
â”‚   â”‚   â””â”€â”€ service_drop/       # æœåŠ¡é¢„çƒ­
â”‚   â”œâ”€â”€ models/                 # æ¨¡å‹ç›¸å…³
â”‚   â”‚   â””â”€â”€ embedding/          # å‘é‡åµŒå…¥æœåŠ¡
â”‚   â”œâ”€â”€ check_weight/           # æƒé‡æ£€æŸ¥
â”‚   â””â”€â”€ user_tasks/             # ä»»åŠ¡ç®¡ç†
â”œâ”€â”€ NFS_server/                 # NFS æœåŠ¡å™¨
â”‚   â”œâ”€â”€ send_weight/            # æƒé‡åˆ†å‘
â”‚   â””â”€â”€ show.py                 # æ–‡ä»¶æœåŠ¡
â”œâ”€â”€ Multimodal_files/           # å¤šæ¨¡æ€æ¨¡å‹æ–‡ä»¶
â”‚   â”œâ”€â”€ CogVideoX/              # è§†é¢‘ç”Ÿæˆæ¨¡å‹
â”‚   â””â”€â”€ Stable-diffusion/       # å›¾åƒç”Ÿæˆæ¨¡å‹
â”œâ”€â”€ Jetson/                     # Jetson ARM æ¶æ„æ”¯æŒ
â”‚   â”œâ”€â”€ Dockerfiles/             # ARM æ¶æ„é•œåƒæ„å»ºæ–‡ä»¶
â”‚   â””â”€â”€ deployment/                   # å­˜å‚¨èµ„æºæŸ¥è¯¢å·¥å…·
â”œâ”€â”€ prometheus/                 # Prometheus é…ç½®
â”œâ”€â”€ test/                       # æµ‹è¯•å·¥å…·
â”‚   â”œâ”€â”€ send_task.py           # å¹¶å‘æµ‹è¯•
â”‚   â””â”€â”€ source_datasets/       # æµ‹è¯•æ•°æ®é›†
â”œâ”€â”€ web-end.py                  # Web å‰ç«¯æœåŠ¡
â”œâ”€â”€ celery.conf                 # Celery é…ç½®
â””â”€â”€ environment.yml             # Python ç¯å¢ƒé…ç½®
```

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](LICENSE) è®¸å¯è¯ã€‚

---

<div align="center">

**â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ Starï¼**

Made with â¤ï¸ by DIAMM Team

</div>
